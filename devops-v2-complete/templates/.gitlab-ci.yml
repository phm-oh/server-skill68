# ===========================================
# ðŸš€ GitLab CI/CD Pipeline
# à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™à¸—à¸±à¸à¸©à¸°à¸§à¸´à¸Šà¸²à¸Šà¸µà¸ž
# ===========================================
# à¹„à¸Ÿà¸¥à¹Œà¸™à¸µà¹‰à¸§à¸²à¸‡à¹„à¸§à¹‰à¸—à¸µà¹ˆ root à¸‚à¸­à¸‡ project
# à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œ: .gitlab-ci.yml
# ===========================================

stages:
  - build
  - push
  - deploy

variables:
  # Registry settings
  REGISTRY: "192.168.100.101:5000"
  
  # Image names
  BACKEND_IMAGE: "$REGISTRY/skill68-backend"
  FRONTEND_IMAGE: "$REGISTRY/skill68-frontend"
  
  # Production server
  PROD_SERVER: "192.168.100.102"
  PROD_USER: "user"  # à¹à¸à¹‰à¹€à¸›à¹‡à¸™ username à¸ˆà¸£à¸´à¸‡

# ===========================================
# Build Stage
# ===========================================

build-backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ðŸ”¨ Building Backend..."
    - cd backend
    - docker build -t $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA $BACKEND_IMAGE:latest
  only:
    - main
    - master

build-frontend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ðŸ”¨ Building Frontend..."
    - cd frontend
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA $FRONTEND_IMAGE:latest
  only:
    - main
    - master

# ===========================================
# Push Stage
# ===========================================

push-images:
  stage: push
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ðŸ“¦ Pushing to Registry..."
    # Push Backend
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $BACKEND_IMAGE:latest
    # Push Frontend
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $FRONTEND_IMAGE:latest
  only:
    - main
    - master

# ===========================================
# Deploy Stage
# ===========================================

deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ SSH client
    - apk add --no-cache openssh-client
    # à¸ªà¸£à¹‰à¸²à¸‡ SSH key (à¸•à¹‰à¸­à¸‡à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² SSH_PRIVATE_KEY à¹ƒà¸™ GitLab CI/CD Variables)
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $PROD_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Deploying to Production..."
    - |
      ssh $PROD_USER@$PROD_SERVER << 'ENDSSH'
        cd /opt/app
        
        # Pull latest images
        docker pull 192.168.100.101:5000/skill68-backend:latest
        docker pull 192.168.100.101:5000/skill68-frontend:latest
        
        # Restart containers
        docker compose down
        docker compose up -d
        
        echo "âœ… Deployment complete!"
      ENDSSH
  only:
    - main
    - master
  when: manual  # à¸•à¹‰à¸­à¸‡à¸à¸”à¸›à¸¸à¹ˆà¸¡ Deploy à¹€à¸­à¸‡

# ===========================================
# Alternative: Deploy without SSH (à¸‡à¹ˆà¸²à¸¢à¸à¸§à¹ˆà¸²)
# ===========================================
# à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸­à¸¢à¸²à¸à¹ƒà¸Šà¹‰ SSH à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸§à¸´à¸˜à¸µà¸™à¸µà¹‰à¹à¸—à¸™:
# 1. à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™ push code
# 2. Pipeline build & push image
# 3. à¸à¸£à¸£à¸¡à¸à¸²à¸£/à¸™à¸±à¸à¹€à¸£à¸µà¸¢à¸™ ssh à¹€à¸‚à¹‰à¸² VM2 à¹à¸¥à¹‰à¸§à¸£à¸±à¸™ docker compose up -d à¹€à¸­à¸‡

deploy-simple:
  stage: deploy
  image: alpine:latest
  script:
    - echo "âœ… Images pushed to registry!"
    - echo ""
    - echo "ðŸ“‹ To deploy manually on VM2 (ssh user@192.168.100.102)"
    - echo "  cd /opt/app"
    - echo "  docker compose pull"
    - echo "  docker compose up -d"
  only:
    - main
    - master
  when: manual
